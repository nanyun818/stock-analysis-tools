# Tushare API 代理问题解决方案

## 问题描述

您遇到的错误信息表明，Tushare API 在尝试通过本地代理（127.0.0.1:7897）连接到 Tushare 服务器时失败了：

```
获取股票列表失败: HTTPConnectionPool(host='127.0.0.1', port=7897): Max retries exceeded with url: http://api.waditu.com/dataapi/stock_basic (Caused by ProxyError('Unable to connect to proxy', NewConnectionError('<urllib3.connection.HTTPConnection object at 0x000002917265D010>: Failed to establish a new connection: [WinError 10061] 由于目标计算机积极拒绝，无法连接。')))
```

这个错误表明：

1. 程序正在尝试使用本地代理（127.0.0.1:7897）
2. 该代理服务器没有运行或无法连接
3. 导致连接到 Tushare API 服务器失败

## 解决方案

我已经为您创建了两个解决方案文件：

### 1. 简单版本：`tushare_no_proxy.py`

这是一个简化版本的爬虫程序，它：
- 禁用了系统代理设置
- 只包含获取股票列表的基本功能
- 适合快速测试连接问题

使用方法：
```
python tushare_no_proxy.py
```

### 2. 完整版本：`tushare_proxy_fix.py`

这是一个更全面的解决方案，提供了多种修复方法：
- 方法1：禁用系统代理
- 方法2：设置直接连接
- 方法3：修改连接超时时间
- 方法4：尝试使用备用API地址

使用方法：
```
python tushare_proxy_fix.py --token 您的TOKEN --method 1
```

或者直接运行，按提示输入：
```
python tushare_proxy_fix.py
```

## 其他可能的解决方法

如果上述方法仍然无法解决问题，您可以尝试：

### 1. 检查系统代理设置

在 Windows 系统中：
- 打开「设置」→「网络和 Internet」→「代理」
- 关闭「自动检测设置」和「使用设置脚本」
- 关闭「使用代理服务器」

### 2. 检查环境变量

在命令提示符中运行以下命令来临时禁用代理：
```
set http_proxy=
set https_proxy=
```

### 3. 检查防火墙设置

确保 Python 程序可以访问互联网，没有被防火墙阻止。

### 4. 联系 Tushare 官方支持

如果问题持续存在，可能是 Tushare API 服务器端的问题，建议联系 Tushare 官方支持。

## 技术说明

### 代理问题的原因

这个问题通常有几种可能的原因：

1. **系统代理设置**：您的系统可能配置了全局代理（127.0.0.1:7897），但该代理服务器没有运行。

2. **Python 环境变量**：Python 可能从环境变量中读取了代理设置。

3. **Tushare 库内部设置**：Tushare 库可能有自己的代理设置逻辑。

### 解决方案的工作原理

提供的解决方案通过以下方式解决问题：

1. 显式清除环境变量中的代理设置：
   ```python
   os.environ['http_proxy'] = ''
   os.environ['https_proxy'] = ''
   ```

2. 增加连接超时时间，允许更长的连接等待时间：
   ```python
   ts.pro_api(timeout=60)
   ```

3. 提供更友好的错误处理和故障排除提示。

希望这些解决方案能帮助您成功连接到 Tushare API！